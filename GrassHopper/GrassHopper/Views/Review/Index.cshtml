<script>
    let APP_ID = '@(Model.FacebookAppId)';
    let APP_SECRET = '@(Model.FacebookAppSecret)';
    let PAGE_ID = '227047383835993';
    let METHOD = 'GET';
    let VERSION = 'v19.0';
    let PATH = `/${PAGE_ID}/ratings?fields=created_time,review_text,rating`;
    let PARAMS = {};

    let APP_SCOPED_UID = '306703255792712';
    let SHORT_PAGE_ACCESS_TOKEN = 'EAAQSjasTnxABO5jglSZCjaxWXeSjncX1Qx02nbzcuxZByNP4cxj67aUZBy3PP4aQdAZCbKYibd2FH7C45ZAmASHPs3NheoflxOZCw8nLn17zmS9vjYjxKqC2sCv3AfVESxhVukZAVt1zsAlqZAD6U63Ib7sOpHrUSzVYV9ZCtoDSr0ObhaimFnalrF8Nn31Jui4POyNF78wxtlhHUAIwsh104bsgG';

    let loadFBReviews = (response) => {
        let reviews = response.data;
        console.log(reviews);

        reviews.forEach(review => {
            let reviewCard = document.createElement('div');
            reviewCard.className = 'card';

            reviewCard.innerHTML = `
                    <div class="card-header">
                        <div class="name">${review.reviewer_name || 'Anonymous'}</div>
                        <div class="date">${new Date(review.created_time).toLocaleDateString()}</div>
                    </div>
                    <div class="card-body">
                        <p class="card-text">${review.review_text || 'No review text'}</p>
                        <div class="stars">${review.rating} Stars / 5 Stars</div>
                    </div>
                `;

            reviewsContainer.appendChild(reviewCard);
        });

        document.addEventListener("DOMContentLoaded", function () {
            var reviews = document.querySelectorAll(".card");
            reviews.forEach(function (review, index) {
                setTimeout(function () {
                    review.classList.add("active");
                }, 100 * index);
            });
        });
    };

    window.fbAsyncInit = function () {
        FB.init({
            appId: APP_ID,
            xfbml: true,
            version: VERSION
        });

        if ('@(ViewBag.lpaToken)' != "none") {
            PARAMS.access_token = '@(ViewBag.lpaToken)';
            FB.api(PATH, METHOD, PARAMS, loadFBReviews);
        } else {
            if ('@(ViewBag.luaToken)' != "none") {
                let longPAccessTokenPath = `/${APP_SCOPED_UID}/accounts?`;
                let longPAccessParams = { access_token: '@(ViewBag.luaToken)' }
                FB.api(longPAccessTokenPath, METHOD, longPAccessParams, (response) => {
                    let long_paccess_token = response.data[0].access_token;

                    let el = document.createElement('a');
                    el.setAttribute('href', "/Review/Index?longPAccessToken=" + long_paccess_token);
                    document.body.appendChild(el);
                    el.click();

                    PARAMS.access_token = long_paccess_token;
                    FB.api(PATH, METHOD, PARAMS, loadFBReviews);
                });
            } else {
                let longUAccessTokenPath = `/oauth/access_token?grant_type=fb_exchange_token`;
                let longUAccessTokenParams = {
                    fb_exchange_token: SHORT_PAGE_ACCESS_TOKEN,
                    client_secret: APP_SECRET,
                    client_id: APP_ID
                }
                FB.api(longUAccessTokenPath, METHOD, longUAccessTokenParams, (response) => {
                    let long_uaccess_token = response.access_token;

                    let el = document.createElement('a');
                    el.setAttribute('href', "/Review/Index?longUAccessToken=" + long_uaccess_token);
                    document.body.appendChild(el);
                    el.click();

                    let longPAccessTokenPath = `/${APP_SCOPED_UID}/accounts?`;
                    let longPAccessParams = { access_token: long_uaccess_token }
                    FB.api(longPAccessTokenPath, METHOD, longPAccessParams, (response) => {
                        let long_paccess_token = response.data[0].access_token;

                        let el = document.createElement('a');
                        el.setAttribute('href', "/Review/Index?longPAccessToken=" + long_paccess_token);
                        document.body.appendChild(el);
                        el.click();

                        PARAMS.access_token = long_paccess_token;
                        FB.api(PATH, METHOD, PARAMS, loadFBReviews);
                    });
                });
            }
        }
    };
</script>
<script async defer crossorigin='anonymous' src='https://connect.facebook.net/en_US/sdk.js'></script>

<div class="container">
    <div class="body">
        @foreach (var review in Model.Reviews)
        {
            <div class="card">
                <div class="card-header">
                    <div class="name">@review.ReviewerName</div>
                    <div class="date"> @review.ReviewDate.ToString("d")</div>
                </div>
                <div class="card-body">
                    <p class="card-text">@review.ReviewBody</p>
                    <div class="stars">@review.ReviewRating Stars / 5 Stars</div>
                </div>
            </div>
        }
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var reviews = document.querySelectorAll(".card");
        reviews.forEach(function (review, index) {
            setTimeout(function () {
                review.classList.add("active");
            }, 100 * index);
        });
    });
</script>

<style>
    .card {
        opacity: 0;
        transform: translateY(50px);
        transition: opacity 0.5s ease, transform 0.5s ease;
    }

        .card.active {
            opacity: 1;
            transform: translateY(0);
        }

</style>